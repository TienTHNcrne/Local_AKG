/** @format */
import React, { useEffect, useState } from "react";
import axios from "axios";
import styles from "./TinhHoa.module.scss";
import Place from "./components/Place/Place.jsx";
import Festival from "./components/Festival/Festival.jsx";

import AddFes from "./components/Festival/components/addFes/AddFes.jsx";
export default function TinhHoa() {
    const [keyword, setKeyword] = useState("");
    const [filter, setFilter] = useState("All");
    const [form, setForm] = useState("place"); // tab hi·ªán t·∫°i
    const [placeData, setPlaceData] = useState([]);
    const [eventData, setEventData] = useState([]);
    const [loading, setLoading] = useState(false);
    const [showAdd, setShowAdd] = useState(false);

    const normalize = (str) =>
        str
            ?.toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "") || "";

    useEffect(() => {
        const fetchPlace = async () => {
            try {
                setLoading(true);
                const res = await axios.get(
                    `${import.meta.env.VITE_BE_URL}/v1/api/gps/all`
                );
                setPlaceData(res.data);
            } catch (err) {
                console.error("L·ªói khi fetch place:", err.message);
            } finally {
                setLoading(false);
            }
        };

        const fetchEvent = async () => {
            try {
                setLoading(true);
                const res = await axios.get(
                    `${import.meta.env.VITE_BE_URL}/v1/api/festival/GetAll`
                );
                setEventData(res.data);
            } catch (err) {
                console.error("L·ªói khi fetch event:", err.message);
            } finally {
                setLoading(false);
            }
        };

        if (form === "place" && placeData.length === 0) fetchPlace();
        if (form === "event" && eventData.length === 0) fetchEvent();
    }, [form]);

    const currentData =
        form === "place" ? placeData : form === "event" ? eventData : [];

    const filteredData = currentData.filter((item) => {
        const name = normalize(item.name);
        const category = normalize(item.category);
        const desc = normalize(item.description);
        const key = normalize(keyword);

        const matchKeyword =
            name.includes(key) || category.includes(key) || desc.includes(key);
        const matchFilter =
            filter === "All" || normalize(item.category) === normalize(filter);

        return matchKeyword && matchFilter;
    });

    return (
        <div className={styles.container}>
            {/* Tabs ch·ªçn form */}
            <div className={styles.tabs}>
                <button
                    className={form === "place" ? styles.active : ""}
                    onClick={() => setForm("place")}
                >
                    ƒê·ªãa ƒëi·ªÉm
                </button>
                <button
                    className={form === "food" ? styles.active : ""}
                    onClick={() => setForm("food")}
                >
                    M√≥n ƒÉn
                </button>
                <button
                    className={form === "event" ? styles.active : ""}
                    onClick={() => setForm("event")}
                >
                    L·ªÖ h·ªôi
                </button>
            </div>

            {/* Search + Filter */}
            <div className={styles.header}>
                <div className={styles.second}>
                    <input
                        type="text"
                        placeholder="T√¨m ki·∫øm..."
                        value={keyword}
                        onChange={(e) => setKeyword(e.target.value)}
                    />
                    {form === "place" ? (
                        <div className={styles.filter}>
                            <select
                                name="filter"
                                value={filter}
                                onChange={(e) => setFilter(e.target.value)}
                            >
                                <option value="All">T·∫•t c·∫£</option>
                                <option value="Di t√≠ch l·ªãch s·ª≠">
                                    Di t√≠ch l·ªãch s·ª≠
                                </option>
                                <option value="Du l·ªãch t√¢m linh">
                                    Du l·ªãch t√¢m linh
                                </option>
                                <option value="Danh lam th·∫Øng c·∫£nh">
                                    Danh lam th·∫Øng c·∫£nh
                                </option>
                                <option value="·∫®m th·ª±c">·∫®m th·ª±c</option>
                            </select>
                        </div>
                    ) : form === "event" || form === "food" ? (
                        <button onClick={() => setShowAdd(true)}>
                            Add Data
                        </button>
                    ) : null}
                </div>
            </div>

            {loading ? (
                <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
            ) : filteredData.length === 0 ? (
                <p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>
            ) : form === "place" ? (
                <Place filteredData={filteredData} />
            ) : form === "food" ? (
                <p>üìå Danh s√°ch m√≥n ƒÉn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>
            ) : form === "event" ? (
                <Festival filteredData={filteredData} />
            ) : null}

            {showAdd && form === "event" && <AddFes setShow={setShowAdd} />}
        </div>
    );
}
